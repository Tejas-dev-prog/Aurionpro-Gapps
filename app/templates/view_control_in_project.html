{% extends "layouts/sidebar-nav.html" %}
{% import "helpers/snippets.html" as snippet with context %}
{% block before_head %}
{{ super() }}
{% import "helpers/src_macros.html" as macro %}
{{ macro.filehelper(apex=True,select2=True,mentions=True,editor=True,confetti=True) }}
  <style>
    .breadcrumbs>ul>li+:before {
      margin-top: 5px;
    }
  </style>
{% endblock %}

{%block page_header%}{%endblock%}

{%block tenant_btn%}{%endblock%}
{%set is_auditor = project.has_auditor(current_user)%}
{%block content%}
<div x-data="app()">
<div class="grid grid-cols-9 gap-8">
  <div class="col-span-9">

<div class="lg:flex lg:items-center lg:justify-between">
  <div class="min-w-0 flex-1">
    <div class="breadcrumbs text-2xl font-bold  sm:tracking-tight">
      <ul>
        <li><a href="{{url_for("main.projects")}}">Projects</a></li>
        <li><a class="capitalize" href="{{url_for("main.view_project",pid=project.id)}}">{{project.name}}</a></li>
        <li><a class="capitalize" href="{{url_for("main.view_project",pid=project.id,tab="controls")}}">Controls</a></li>
        <li><a class="uppercase text-primary hover:text-primary-focus" href="{{url_for("main.view_project",pid=project.id)}}">{{project_control.control.ref_code}}</a></li>
      </ul>
    </div>
  </div>
  <div class="flex">
    <span id="applicable-div" class="ml-3 hidden sm:block">
      <button class="btn btn-sm"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="w-5 h-5 animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></button>
    </span>
    <span class="ml-3 hidden sm:block">
      <button class="btn format-btn reload-button btn-ghost border border-base-300 btn-sm">Reload<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ml-2 svg-reload"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg></button>
    </span>
    <span class="ml-3 hidden sm:block">
      <button class="btn btn-ghost border border-base-300 btn-sm" @click="document.getElementById('help-modal').checked = true">Help<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg></button>
    </span>
  </div>
</div>

    <div class="flex flex-row border-b border-base-300 py-3">
      <div class="flex gap-x-2 py-1 pr-2 tooltip" data-tip="Framework">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>
        <span class="text-sm font-medium capitalize">{{project.framework.name}}</span>
      </div>
      <div class="flex gap-x-2 py-1 px-2 tooltip" data-tip="Completion">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
        <span class="text-sm font-medium">{{project.progress("complete")}}%</span>
      </div>
      <div class="flex gap-x-2 py-1 px-2 tooltip" data-tip="Started at">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z" /></svg>
        <span class="text-sm font-medium">{{project.simple(project.date_added)}}</span>
      </div>
      {%if is_auditor%}
      <div class="flex gap-x-2 py-1 px-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
        <span class="text-sm font-medium">Auditor</span>
      </div>
      {%endif%}
      <div class="divider divider-horizontal mx-0"></div>
      <div class="flex gap-x-6 tabs">
        <button
          x-on:click="changeTab('overview')"
          x-bind:class="{ 'tab-active border-primary border-b-2': tab === 'overview' }"
          class="tab hover:text-primary tab-md capitalize text-sm font-semibold focus:border-primary"
        >
          Overview<span class="ml-1 text-sm" id="overview-title"></span>
        </button>
        <button
          x-on:click="changeTab('subcontrols')"
          x-bind:class="{ 'tab-active border-primary border-b-2': tab === 'subcontrols' }"
          class="tab hover:text-primary tab-md capitalize text-sm font-semibold focus:border-primary"
        >
          Subcontrols<span class="ml-1 text-sm" id="subcontrols-title"></span>
        </button>
        <button
          x-on:click="changeTab('comments')"
          x-bind:class="{ 'tab-active border-primary border-b-2': tab === 'comments' }"
          class="tab hover:text-primary tab-md capitalize text-sm font-semibold focus:border-primary"
        >
          Comments<span class="ml-1 text-sm" id="comments-title"></span>
        </button>
        <button
          x-on:click="changeTab('todo')"
          x-bind:class="{ 'tab-active border-primary border-b-2': tab === 'todo' }"
          class="tab hover:text-primary tab-md capitalize text-sm font-semibold focus:border-primary"
        >
          Auditor Feedback<span class="ml-1 text-sm" id="feedback-title"></span>
        </button>
        {%if not is_auditor%}
        <button
          x-on:click="changeTab('internal-notes')"
          x-bind:class="{ 'tab-active border-primary border-b-2': tab === 'internal-notes' }"
          class="tab hover:text-primary tab-md capitalize text-sm font-semibold focus:border-primary"
        >
          Notes<span class="ml-1 text-sm" id="notes-title">{%if project_control.notes%}<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 text-orange-400"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>{%endif%}</span>
        </button>
        {%endif%}
        {%if is_auditor%}
        <button
          x-on:click="changeTab('auditor-notes')"
          x-bind:class="{ 'tab-active border-primary border-b-2': tab === 'auditor-notes' }"
          class="tab hover:text-primary tab-md capitalize text-sm font-semibold focus:border-primary"
        >
          Auditor Notes<span class="ml-1 text-sm" id="auditor-notes-title">{%if project_control.auditor_notes%}<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-orange-400"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>{%endif%}</span>
        </button>
        {%endif%}
      </div>
    </div>

</div>
</div>

<div class="grid grid-cols-9 gap-4 mb-4">
  <div id="alert-div" class="col-span-9"></div>
  <div class="col-span-9" x-show="tab === 'overview'">
    <div class="grid grid-cols-9 gap-4">
      <div id="stats-div" class="col-span-9"></div>
      <div id="summary-div" class="col-span-6"></div>
      <div id="charts-div" class="col-span-3"></div>
    </div>
  </div>
  {%if not is_auditor%}
  <div class="col-span-9" x-show="tab === 'internal-notes'">
        <div class="mb-4 justify-between flex">
          <div>
            <h1 class="text-2xl font-bold">Internal Notes</h1>
            <p class="text-sm">Internal notes are not viewable by the auditor/reviewer</p>
          </div>
          <button @click="saveNotes" class="btn btn-primary btn-sm">Save</button>
        </div>
        <div id="internal-editor" class="mb-5">{%if project_control.notes%}{{project_control.notes|safe}}{%endif%}</div>
  </div>
  {%endif%}
  {%if is_auditor%}
  <div class="col-span-9" x-show="tab === 'auditor-notes'">
        <div class="mb-4 justify-between flex">
          <div>
            <h1 class="text-2xl font-bold">Auditor Notes</h1>
            <p class="text-sm">Auditor notes are not viewable by the InfoSec team</p>
          </div>
          <button @click="saveAuditorNotes" class="btn btn-primary btn-sm">Save</button>
        </div>
        <div id="auditor-editor" class="mb-5">{%if project_control.auditor_notes%}{{project_control.auditor_notes|safe}}{%endif%}</div>
  </div>
  {%endif%}
  <div class="col-span-9" x-show="tab === 'subcontrols'">
    <div id="subcontrols-div" class="col-span-9 pb-10"></div>
  </div>
  <div class="col-span-9" x-show="tab === 'comments'" @reload.window="getComments()">
        <div class="mb-4 justify-between flex">
          <div>
            <h1 class="text-2xl font-bold">Comments<span id="comment-count" class="ml-2"></span></h1>
            <p class="text-sm">Comments are used by the InfoSec team and Auditor to converse about the control</p>
          </div>
          <div class="my-auto flex justify-between gap-x-2">
            <button @click="saveComment" class="btn btn-sm btn-primary">Send</button>
          </div>
        </div>
        <div class="mb-5">
          <textarea id="comment" rows="4" class="textarea textarea-bordered w-full text-sm" placeholder="Write a comment..." required=""></textarea>
          <div class=" h-[calc(100vh-500px)] overflow-auto px-3" id="comments"></div>
        </div>
  </div>
  <div class="col-span-9">
    <div class="mx-auto rounded-lg" x-show="tab === 'todo'" @reload.window="todos=[];getItems()">
        <div class="mb-4 flex justify-between">
          <div>
            <h1 class="text-2xl font-bold">Feedback<span id="feedback-count" class="ml-2"></span></h1>
            <p class="text-sm">Feedback is used by the Auditor to list action items and/or questions for the InfoSec team to complete. The Auditor and InfoSec team should mark completion. Note: Feedback is attached to each subcontrol. {%if is_auditor%}If you would like to add new feedback, please click under the specific subcontrol.{%endif%}</p>
          </div>
        </div>
        <div id="feedback-body" class="h-[calc(100vh-400px)] overflow-auto px-3">
            <template x-if="todos.length">
                <ul @click.away="defocusItems()" class="">
                    <template x-for="(item,index) in todos">
                        <div class="tooltip tooltip-bottom w-full text-left" data-tip="Double click to view">
                        <li @click="focusItem(index)" @mousedown="if ($event.detail>1){$event.preventDefault()}" @dblclick="openItem(index)" class="px-4 py-2 rounded-lg transition-all flex text-md hover:bg-base-300" :class="{'bg-base-200':item.focused,'shadow-lg py-4 my-5 border':item.open,'mb-1 border border-base-300 cursor-pointer':!item.open}" :key="index">
                            <div class="flex-none leading-none py-2">
                                <div class="flex flex-row gap-x-6 text-xs leading-none font-semibold text-base-content">
                                        <div class="flex flex-col gap-y-2">
                                          <p class="mx-auto">InfoSec Team</p>
                                          <input class="checkbox border-2 mx-auto" :id="`feedback-${item.id}`" type="checkbox" :checked="item.is_complete" @click="checkItem(index)" {%if is_auditor%}disabled{%endif%}>
                                        </div>
                                        <div class="flex flex-col gap-y-2">
                                          <p class="mx-auto">Auditor</p>
                                          <input class="checkbox border-2 mx-auto" type="checkbox" :checked="item.auditor_complete" @click="checkAuditorItem(index)" {%if not is_auditor%}disabled{%endif%}>
                                        </div>
                                </div>
                            </div>
                            <div class="flex-grow max-w-full py-4 ml-8 my-auto">
                                <div class="w-full leading-none">
                                    <h3 class="text-sm w-full  mt-1 font-semibold capitalize text-base-content" :class="item.title.length?'text-base-content':'text-primary'" x-text="item.title||'Add Feedback...'" x-show="!item.open"></h3>
                                    <input type="text" x-show="item.open" class="text-md w-full bg-transparent leading-none focus:outline-none mb-2" x-model="item.title" :id="`titleField${index}`" placeholder="Add Feedback..." {%if not is_auditor%}disabled{%endif%}/>
                                </div>
                                <div class="w-full" x-show="item.open" x-data="{content:`Note: This feedback is tied to the Subcontrol ID:${item.subcontrol_id}. If you would like to add new feedback, view more details or converse, <a class='text-red-500 underline' target='_blank' rel='noopener noreferrer' href='/projects/{{project.id}}/controls/{{project_control.id}}/subcontrols/${item.subcontrol_id}'>please view the subcontrol</a>`}">
                                  <p class="text-xs font-semi-bold mb-2" x-html="content"></p>
                                </div>           
                                <div class="w-full" x-show="item.open">
                                    <label class="block text-sm font-medium">Auditor Description</label>
                                    <textarea class="textarea bg-base-200 w-full leading-tight my-2" rows="3" x-model="item.description" placeholder="Enter notes or supporting items to help the team" {%if not is_auditor%}disabled{%endif%}></textarea>
                                </div>
                                <div class="w-full" x-show="item.open">
                                    <label class="block text-sm font-medium">InfoSec Response</label>
                                    <textarea class="textarea bg-base-200 w-full leading-tight my-2" rows="3" @change="updateItem(index)" x-model="item.response" placeholder="Provide a explanation to the Auditors action item or question." {%if is_auditor%}disabled{%endif%}></textarea>
                                </div>
                                <div class="w-full flex justify-end" x-show="item.open">
                                    <button class="btn btn-success mr-2" @click="updateItem(index)">Save</button>
                                    <a target="_blank" rel="noopener noreferrer" x-bind:href="'/projects/{{project.id}}/controls/{{project_control.id}}/subcontrols/' + item.subcontrol_id + '?tab=todo'" class="btn btn-primary mr-2">View Item</a>
                                    {%if is_auditor%}
                                    <button class="btn btn-error" @click="removeItem(index)">Delete</button>
                                    {%endif%}
                                </div>
                            </div>
                        </li>
                        </div>
                    </template>
                </ul>
            </template>
            <template x-if="!todos.length">
                <p class="text-primary text-xl font-semibold mx-auto text-center mt-5"><b class="mr-2">😊</b>No Feedback</p>
            </template>
        </div>
    </div>
  </div>
</div>
</div>

<input type="checkbox" id="guidance-modal" class="modal-toggle" />
<label for="guidance-modal" class="modal cursor-pointer">
  <label class="modal-box relative w-11/12 max-w-5xl" for="">
    <div class="flex justify-between">
      <div>
        <h2 class="card-title mb-5">Control Guidance</h2>
      </div>
    </div>
    {%if project_control.control.guidance%}
    {{project_control.control.guidance|safe}}
    {%else%}
    There is no guidance for this control at this time. Please see the <a class="text-primary font-semibold underline" href="https://github.com/bmarsh9/gapps/issues/31">Github issue</a> for more information.
    {%endif%}
  </label>
</label>

<input type="checkbox" id="help-modal" class="modal-toggle" />
<label for="help-modal" class="modal cursor-pointer">
  <label class="modal-box relative w-11/12 max-w-5xl" for="">
    <div class="flex justify-between">
      <div>
        <h2 class="card-title mb-5">Help</h2>
      </div>
    </div>
    You are currently viewing a single control within your project. Each control will have subcontrols. So for example, the current control has {{project_control.subcontrols.count()}} subcontrol(s). In order to complete the control, you must complete all of the subcontrols. For each subcontrol, you can click into the "Auditor Collab" page. This page allows you to converse with the Auditor/Reviewer about the subcontrol.<br><br>If you do not believe the control is Applicable, you can mark the control as "Non-Applicable" and it will be excluded from your project. You can also mark individual subcontrols as "Non-Applicable".
  </label>
</label>
{%endblock%}
{%block extrajs%}
<script>
function saveNotes() {
    var data = {"data":tinymce.get("internal-editor").getContent()}
    $.ajax({
        type: "PUT",
        url: `/api/v1/projects/{{project.id}}/controls/{{project_control.id}}/notes`,
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
            toast("Saved notes")
            return(data)
        },
        error: function(errMsg) {
            toast(errMsg["responseJSON"]["message"],"error")
            return(errMsg);
        }
    })
}

function saveAuditorNotes() {
    var data = {"data":tinymce.get("auditor-editor").getContent()}
    $.ajax({
        type: "PUT",
        url: `/api/v1/projects/{{project.id}}/controls/{{project_control.id}}/auditor-notes`,
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
            toast("Saved notes")
            return(data)
        },
        error: function(errMsg) {
            toast(errMsg["responseJSON"]["message"],"error")
            return(errMsg);
        }
    })
}
var internalEditor = tinymce.init({
  selector: '#internal-editor',
  statusbar: false,
  promotion: false,
  plugins: "preview fullscreen searchreplace table codesample lists advlist variable link",
  toolbar1: "bold italic strikethrough forecolor backcolor | fontfamily fontsize blocks | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat undo redo"
});
var auditorEditor = tinymce.init({
  selector: '#auditor-editor',
  statusbar: false,
  promotion: false,
  plugins: "preview fullscreen searchreplace table codesample lists advlist variable link",
  toolbar1: "bold italic strikethrough forecolor backcolor | fontfamily fontsize blocks | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat undo redo"
});
function getComments() {
    $.ajax({
        type: "GET",
        url: `/api/v1/projects/{{project.id}}/controls/{{project_control.id}}/comments`,
        data: JSON.stringify({"data":document.getElementById("comment").value}),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
            $("#comments").html("")
            $("#comment-count").html(`(${data.length})`)
            if (data) {
              $("#comments-title").html(`(${data.length})`)
            }
            for (var comment in data) {
              addCommentToDiv(data[comment])
            }
            mention_options = [];
            var users = JSON.parse(localStorage.getItem("tenant-users-{{project.tenant_id}}"));
            for(user in users) {
              mention_options.push({key:users[user].email, value:users[user].username})
            }
            var tribute = new Tribute({values:mention_options});
            tribute.attach(document.getElementById("comment"));
            return(data)
        },
        error: function(errMsg) {
            toast(errMsg["responseJSON"]["message"],"error")
            return(errMsg);
        }
    })
}
function deleteComment(id) {
    $.ajax({
        type: "DELETE",
        url: `/api/v1/projects/{{project.id}}/controls/{{project_control.id}}/comments/${id}`,
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
            $(`#comment-${id}`).remove()
            toast("Deleted comment")
            return(data)
        },
        error: function(errMsg) {
            toast(errMsg["responseJSON"]["message"],"error")
            return(errMsg);
        }
    })
}
function saveComment(e) {
    var value = document.getElementById("comment").value;
    if (!value) {
      return
    }
    $.ajax({
        type: "POST",
        url: `/api/v1/projects/{{project.id}}/controls/{{project_control.id}}/comments`,
        data: JSON.stringify({"data":value}),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data){
            addCommentToDiv(data)
            document.getElementById("comment").value = ""
            toast("Added comment")
            getComments()
            return(data)
        },
        error: function(errMsg) {
            toast(errMsg["responseJSON"]["message"],"error")
            return(errMsg);
        }
    })
}

function addCommentToDiv(comment) {
  user_id = {{current_user.id}};
  if (user_id === comment.author_id) {
    delete_str = `<div class="dropdown dropdown-end"><label tabindex="0" class="btn btn-sm btn-ghost"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM12.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM18.75 12a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"></path></svg></label><ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 bg-neutral text-neutral-content"><li><a @click="deleteComment(${comment.id})">Delete</a></li></ul></div>`
  } else {
    delete_str = ""
  }
  var record = `
    <article id="comment-${comment.id}" class="py-6 mb-6 rounded-lg border-b border-base-200">
        <footer class="flex justify-between items-center mb-2">
            <div class="flex items-center text-sm">
                <div class="avatar placeholder mr-2"><div class="bg-neutral-focus text-neutral-content rounded-full w-6"><span class="text-xs uppercase">${comment.author_email[0]}</span></div></div>${comment.author_email}
                <p class="inline-flex items-center mr-3 text-sm"></p>
                <p class="text-xs font-semibold"><time pubdate="">${comment.date_added}</time></p>
            </div>${delete_str}
        </footer>
        <p class="">${comment.message}</p>
    </article>
  `
  $("#comments").prepend(record)
}
function app(){
    return {
        init() {
          var params = new window.URLSearchParams(window.location.search);
          var tab = params.get('tab');
          if (tab) {
            this.tab = tab;
          }
          this.getItems()
        },
        tab: "overview",
        todos: [],
        changeTab: function(tab) {
          this.tab = tab;
          var queryParams = new URLSearchParams(window.location.search);
          queryParams.set("tab", tab)
          history.replaceState(null, null, "?"+queryParams.toString());
        },
        checkItem: function(index) {
          var item = this.todos[index];
          if (!item.response) {
            toast("Please provide a response", "warning")
            document.getElementById(`feedback-${item.id}`).checked = false;
            return
          }
          item.is_complete=!item.is_complete
          if (item.is_complete) {
            confetti({particleCount: 200,spread: 300,origin: { y: .6 }});
          }
          this.updateItem(index)
        },
        checkAuditorItem: function(index) {
          var item = this.todos[index];
          item.auditor_complete=!item.auditor_complete
          if (item.auditor_complete) {
            confetti({particleCount: 200,spread: 300,origin: { y: .6 }});
          }
          this.updateItem(index)
        },
        updateItem: function(index) {
          var item = this.todos[index];
          var data = {
            "title":item.title,
            "description":item.description,
            "is_complete":item.is_complete,
            "auditor_complete":item.auditor_complete,
            "response":item.response
          }
          $.ajax({
            type: "PUT",
            url: `/api/v1/projects/{{project.id}}/subcontrols/${item.subcontrol_id}/feedback/${item.id}`,
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(data){
              toast("Updated feedback")
              return(data)
            },
            error: function(errMsg) {
              toast(errMsg["responseJSON"]["message"],"error")
              return(errMsg);
            }
          })
        },
        focusItem: function(index) {
            if ( !this.todos[index].open ) {
                for(let i = 0; i < this.todos.length; i++){
                    this.todos[i].open = false;
                    this.todos[i].focused = i == index;
                }
            }
        },
        openItem: function(index) {
            for(let i = 0; i < this.todos.length; i++){
                this.todos[i].focused = false;
                this.todos[i].open = i == index;
            }
            setTimeout(()=>document.getElementById(`titleField${index}`).focus(),10);
        },
        defocusItems: function() {
            for(let i = 0; i < this.todos.length; i++){
                this.todos[i].focused = false;
                this.todos[i].open = false;
            }
        },
        getItems: function() {
          todos = this.todos
          $.ajax({
            type: "GET",
            url: `/api/v1/projects/{{project.id}}/controls/{{project_control.id}}/feedback`,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(data){
              $("#feedback-count").html(`(${data.length})`)
              if (data) {
                $("#feedback-title").html(`(${data.length})`)
              }
              for (var item in data) {
                todos.push(data[item])
              }
              return(data)
            },
            error: function(errMsg) {
              toast(errMsg["responseJSON"]["message"],"error")
              return(errMsg);
            }
          })
        }
    }
}
function loadCharts() {
  $("#charts-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
  $.ajax({
    type: "GET",
    url: "/api/v1/projects/{{project.id}}/controls/{{project_control.id}}",
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      $("#charts-div").html("");

      $("#charts-div").html(`<div class="grid grid-cols-4 gap-y-4">
        <div class="col-span-4"><div class="card  shadow-md border border-base-200"><div class="p-5"><div class="flex justify-between"><div><h2 class="card-title  capitalize text-lg">Implemention Progress</h2></div><div><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" @click="changeTab('subcontrols')" class="w-6 h-6 cursor-pointer"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></div></div><div class="text-center"><div id="implementation-progress"></div></div></div></div></div>
        <div class="col-span-4"><div class="card  shadow-md border border-base-200"><div class="p-5"><div class="flex justify-between"><div><h2 class="card-title  capitalize text-lg">Evidence Collection</h2></div><div><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" @click="changeTab('subcontrols')" class="w-6 h-6 cursor-pointer"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></div></div><div class="text-center"><div id="evidence-progress"></div></div></div></div></div>
      </div>`);

      var options = {
            series: [100-data.progress_implemented,data.progress_implemented],
            legend: {
              show: false
            },
            dataLabels: {
              enabled: false
            },
            chart: {
              type: 'donut',
              height:250
            },
	    plotOptions: {
			pie: {
			  donut: {
				labels: {
				  show: true,
				value:{
				  offsetY: -8,
				  color:'#6b6a6e'
				},
				  total: {
					show: true,
					label: '',
					formatter: () => `${data.progress_implemented}%`
				  }
				}
			  }
			}
	    },
            labels: ['Uncomplete', 'Complete'],
            fill:{colors:['#f3f4f6', '#4ade80']},
            responsive: [{
              breakpoint: 400,
              options: {
                chart: {
                  width: 100
                }
              }
            }]
      };
      var evidence_options = {
            series: [100-data.progress_evidence,data.progress_evidence],
            legend: {
              show: false
            },
            dataLabels: {
              enabled: false
            },
            chart: {
              type: 'donut',
              height:250
            },
	    plotOptions: {
			pie: {
			  donut: {
				labels: {
				  show: true,
				value:{
				  offsetY: -8,
				  color:'#6b6a6e'
				},
				  total: {
					show: true,
					label: '',
					formatter: () => `${data.progress_evidence}%`
				  }
				}
			  }
			}
	    },
            labels: ['Uncomplete', 'Complete'],
            fill:{colors:['#f3f4f6', '#4ade80']},
            responsive: [{
              breakpoint: 100,
              options: {
                chart: {
                  width: 100
                }
              }
            }]
      };
      new ApexCharts(document.querySelector(`#implementation-progress`), options).render()
      new ApexCharts(document.querySelector(`#evidence-progress`), evidence_options).render()
      return(data)
    },
    error: function(errMsg) {
      toast(errMsg["responseJSON"]["message"],"error")
      return(errMsg);
    }
  })
}

function loadSubControls() {
  $("#subcontrols-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
  $.ajax({
    type: "GET",
    url: "/api/v1/projects/{{project.id}}/controls/{{project_control.id}}/subcontrols",
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      $("#subcontrols-div").html("");
      $("#subcontrols-title").html(`(${data.length})`)

      $("#subcontrols-div").html(`
<div class="col-span-6">
  <div class="card bg-base-100 border border-base-200 shadow p-5">
    <div class="my-3">
      <div class="text-lg leading-6 font-medium ">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-primary w-6 h-6 float-left mr-2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11.35 3.836c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m8.9-4.414c.376.023.75.05 1.124.08 1.131.094 1.976 1.057 1.976 2.192V16.5A2.25 2.25 0 0118 18.75h-2.25m-7.5-10.5H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V18.75m-7.5-10.5h6.375c.621 0 1.125.504 1.125 1.125v9.375m-8.25-3l1.5 1.5 3-3.75" />
        </svg>
        Subcontrols for <b class="font-semibold text-primary uppercase">{{project_control.control.ref_code}}</b>
      </div>
      <button class="float-right btn btn-xs toggle-fa">Toggle</button>
      <button class="float-right btn btn-success btn-xs save-all mr-2">Save All</button>
      <p class="mt-1 text-sm ">Complete all subcontrols (by implementing and adding evidence) to satisfy the <b class="text-primary uppercase">{{project_control.control.ref_code}}</b> control. Click into each subcontrol to enter the Auditor Collaboration page.</p>
    </div>
    <div class="border-t border-base-200">
      <div id="subcontrols-body" class="px-4 py-5 sm:grid sm:px-6 gap-y-4">
      </div>
    </div>
  </div>
</div>
`);

      for (var record in data) {
        var gridDiv = $("<div>").addClass("grid grid-cols-10")
        var leftDiv = $("<div>").addClass("col-span-2 flex m-auto gap-2")
        var rightDiv = $("<div>").addClass("col-span-7")
        var nextDiv = $("<div>").addClass("col-span-1 m-auto")

        var obj = data[record]

        if (obj.implemented === 25) {
          var implementationColor = "red-500";
        } else if (obj.implemented === 50) {
          var implementationColor = "orange-500";
        } else if (obj.implemented === 75) {
          var implementationColor = "blue-500";
        } else if (obj.implemented === 100) {
          var implementationColor = "green-500";
        } else {
          var implementationColor = "gray-400";
        }

        if (!obj.is_applicable) {
          // if control is not applicable
          leftDiv.append(`
              <div class="tooltip z-50" data-tip="Not applicable (complete)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-orange-500 w-7 w-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z"/>
                </svg>
              </div>
          `);
        } else {
            var reviewColor = "gray-400"
            if (obj.review_status === "complete") {
              var reviewColor = "green-500"
            } else if (obj.review_status === "infosec action") {
              var reviewColor = "yellow-500"
            } else if (obj.review_status === "ready for auditor") {
              var reviewColor = "blue-500"
            } else if (obj.review_status === "action required") {
              var reviewColor = "red-500"
            }
            // review status from auditor         
            leftDiv.append(`
              <div class="tooltip z-50 capitalize" data-tip="Auditor status: ${obj.review_status}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-${reviewColor} w-7 w-7"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
              </div>
            `)

            // check if control is complete
            if (!obj.is_complete) {
              leftDiv.append(`
                <div class="tooltip tooltip-right z-50 capitalize" data-tip="${obj.implementation_status}">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-${implementationColor} w-7 w-7"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75a4.5 4.5 0 01-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 11-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 016.336-4.486l-3.276 3.276a3.004 3.004 0 002.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852z" /><path stroke-linecap="round" stroke-linejoin="round" d="M4.867 19.125h.008v.008h-.008v-.008z" /></svg>
                </div>
              `);
            } else {
              leftDiv.append(`
                <div class="tooltip tooltip-right z-50" data-tip="Implemented">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-green-500 w-7 w-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z"/>
                  </svg>
                </div>
              `);
            }
            // check if control has evidence
            if (!obj.has_evidence) {
              leftDiv.append(`
                <div class="tooltip z-30" data-tip="No evidence">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-7 w-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m6 4.125l2.25 2.25m0 0l2.25 2.25M12 13.875l2.25-2.25M12 13.875l-2.25 2.25M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"/>
                  </svg>
                </div>
              `);
            } else {
              leftDiv.append(`
                <div class="tooltip z-30" data-tip="Evidence collected">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-green-500 w-7 w-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"/>
                  </svg>
                </div>
              `);
            }
        }
        var applicable = (obj.is_applicable === true) ? 'checked' : '';
        var notes = (obj.notes) ? obj.notes : '';
        var auditor_feedback = (obj.auditor_feedback) ? obj.auditor_feedback : '';
        var mitigation = (obj.mitigation) ? obj.mitigation : 'Mitigation has not been documented';
        rightDiv.append(`
	<div class="col-span-9">
		<div class="collapse border border-primary-content rounded-box collapse-plus hover:bg-base-300 hover:shadow-md">
			<input type="checkbox"/>
			<div class="collapse-title  text-sm font-medium">
				<div class="flex flex-row">
					<h3 class="ml-1 font-semibold">${obj.name}</h3>
				</div>
			</div>
			<div class="collapse-content bg-base-200">
				<div class="overflow-hidden border shadow sm:rounded-lg mt-4">
					<div class="px-4 py-5 sm:px-6 bg-base-200">
						<h3 class="text-lg font-medium leading-6 ">${obj.id} - Subcontrol Details</h3>
						<p class="mt-1 max-w-2xl text-sm ">View detailed information about the subcontrol</p>
					</div>
					<div class="border-t border-base-200 bg-base-100">
                                                <dl class="px-5 pt-5">
				                  <a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}/controls/{{project_control.id}}/subcontrols/${obj.id}" class="btn btn-ghost border border-base-300 btn-block">View Subcontrol<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></a>
						</dl>
						<dl>
							<div class="px-4 py-5 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
								<dt class="text-sm font-medium text-primary my-auto">Applicable</dt>
								<dd class="mt-1 text-sm  sm:col-span-5 sm:mt-0">
						                  <input type="checkbox" class="toggle toggle-primary input-${obj.id}-applicable" ${applicable}/>
								</dd>
							</div>
						</dl>
						<dl>
							<div class=" px-4 py-5 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
								<dt class="text-sm font-medium text-primary my-auto">Implemented</dt>
								<dd class="mt-1 text-sm  sm:col-span-5 sm:mt-0">
									<input data-name="status" type="range" min="0" max="100" value="${obj.implemented}" class="range range-primary input-${obj.id}-implemented" step="25"/>
									<div class="w-full flex justify-between text-xs px-2">
										<span>0%</span>
										<span>25%</span>
										<span>50%</span>
										<span>75%</span>
										<span>100%</span>
									</div>
								</dd>
							</div>
						</dl>
						<dl>
							<div class="px-4 py-5 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
								<dt class="text-sm font-medium text-primary my-auto">Ref Code</dt>
								<dd class="mt-1 text-sm sm:col-span-5 sm:mt-0 text-primary bg-base-200 rounded-full py-1 px-3 w-fit uppercase">${obj.ref_code}</dd>
							</div>
						</dl>
						<dl>
							<div class=" px-4 py-5 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
								<dt class="text-sm font-medium text-primary my-auto">Description</dt>
                                                                <dd x-data="{truncated:true,msg:&quot;${obj.description}&quot;}" class="mt-1 text-sm sm:col-span-5 sm:mt-0">
                                                                  <span x-show="truncated" x-html="msg.substring(0,50)+'<span @click=&quot;truncated=false&quot; class=&quot;text-primary underline cursor-pointer&quot;> ... Show more</span>'"></span>
                                                                  <span x-show="!truncated" x-html="msg+'<span @click=&quot;truncated=true&quot; class=&quot;text-primary underline cursor-pointer&quot;> ... Show less</span>'"></span>
                                                                </dd>

							</div>
						</dl>
						<dl>
							<div class="px-4 py-5 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
								<dt class="text-sm font-medium text-primary my-auto">Mitigation</dt>
                                                                <dd x-data="{truncated:true,msg:&quot;${mitigation}&quot;}" class="mt-1 text-sm sm:col-span-5 sm:mt-0">
                                                                  <span x-show="truncated" x-html="msg.substring(0,50)+'<span @click=&quot;truncated=false&quot; class=&quot;text-primary underline cursor-pointer&quot;> ... Show more</span>'"></span>
                                                                  <span x-show="!truncated" x-html="msg+'<span @click=&quot;truncated=true&quot; class=&quot;text-primary underline cursor-pointer&quot;> ... Show less</span>'"></span>
                                                                </dd>
							</div>
						</dl>
						<dl>
							<div class=" px-4 py-5 sm:grid sm:grid-cols-6 sm:gap-4 sm:px-6">
								<dt class="text-sm font-medium text-primary my-auto">Evidence</dt>
								<dd class="mt-1 text-sm  sm:col-span-5 sm:mt-0">
                                                                  <select class="evidence-selection input-${obj.id}-evidence" style="width: 100%" name="evidence-list[]" multiple="multiple"></select>
								</dd>
							</div>
						</dl>
					</div>
					<button data-id=${obj.id} class="save-fa float-right btn btn-primary m-4 w-20">Save</button>
					<a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}/controls/{{project_control.id}}/subcontrols/${obj.id}" class="float-right btn btn-ghost m-4 mr-4">Auditor Collab</a>
				</div>
			</div>
		</div>
	</div>
        `);
        nextDiv.append(`<a target="_blank" rel="noopener noreferrer" href="/projects/{{project.id}}/controls/{{project_control.id}}/subcontrols/${obj.id}" class="btn btn-ghost">View <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg></a>`);

        gridDiv.append(leftDiv);
        gridDiv.append(rightDiv);
        gridDiv.append(nextDiv);
        $("#subcontrols-body").append(gridDiv);

        // populate select2 for evidence
        $(`.input-${obj.id}-evidence`).select2();
        var tenantEvidence = JSON.parse(localStorage.getItem("evidence"));
        for(var i in tenantEvidence){
          var newOption = new Option(tenantEvidence[i].name, tenantEvidence[i].id, false, false)
          $(`.input-${obj.id}-evidence`).append(newOption).trigger('change');
        }
        var listOfIds = [];
        for(var x in obj.evidence){
          listOfIds.push(obj.evidence[x].id)
        }
        $(`.input-${obj.id}-evidence`).val(listOfIds).trigger('change');
      };
      return(data)
    },
    error: function(errMsg) {
      toast(errMsg["responseJSON"]["message"],"error")
      return(errMsg);
    }
  })
}

function saveEvidenceToLs() {
  // gather evidence for tenant and save to local storage
  $.ajax({
    type: "GET",
    url: "/api/v1/tenants/{{project.tenant_id}}/evidence",
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){
      localStorage.setItem("evidence", JSON.stringify(data))
    },
    error: function(errMsg) {
        toast(errMsg["responseJSON"]["message"],"error")
        return(errMsg);
    }
  })  
}
function setApplicableBtn(applicable=true) {
  if (applicable) {
    $("#applicable-div").html(`<button data-applicable="yes" class="btn btn-na btn-warning btn-sm">Set as: Not Applicable<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>`)
  } else {
    $("#applicable-div").html(`<button data-applicable="no" class="btn btn-na btn-success btn-sm">Set as: Applicable<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg></button>`)
  }
}
function loadSummary() {
  $("#summary-div").html('<div class="col-span-9 mx-auto mt-10"><div class="justify-center flex" role="status"><svg aria-hidden="true" class="mr-2 w-8 h-8  animate-spin fill-blue-600 text-gray-200" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg><span class="sr-only">Loading...</span></div></div>')
  $.ajax({
    type: "GET",
    url: "/api/v1/projects/{{project.id}}/controls/{{project_control.id}}",
    contentType: "application/json; charset=utf-8",
    dataType: "json",
    success: function(data){

      if (!data.is_applicable) {
        $("#alert-div").html('<div class="alert alert-warning shadow-lg "> <div> <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span>This control has been marked as Not Applicable and therefore is complete.</span> </div> </div>');
        setApplicableBtn(false)
      }
      else if (data.is_complete) {
        $("#alert-div").html('<div class="alert alert-success shadow-lg "> <div> <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> <span>This control is fully complete!</span> </div> </div>');
        setApplicableBtn(true)
      } else {
        $("#alert-div").html("")
        setApplicableBtn(true)
      }

      $("#summary-div").html("");
      $("#stats-div").html(`
        <div class="grid grid-cols-8 gap-4">
          <div class="col-span-2 cursor-pointer hover:bg-base-200 hover:shadow-sm" @click="changeTab('subcontrols')"><div class="flex items-start rounded-xl py-4 px-3 border border-base-300"><div class="flex h-8 w-8 my-auto items-center justify-center rounded-full bg-base-200 border border-base-200"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z" /></svg></div><div class="ml-4"><h2 class="font-semibold">Subcontrols Complete</h2><p class="mt-2 text-sm">${data.stats.subcontrols_complete}/${data.stats.subcontrols} complete</p></div></div></div>
          <div class="col-span-2 cursor-pointer hover:bg-base-200 hover:shadow-sm" @click="changeTab('todo')"><div class="flex items-start rounded-xl py-4 px-3 border border-base-300"><div class="flex h-8 w-8 my-auto items-center justify-center rounded-full bg-base-200 border border-base-200"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"></path></svg></div><div class="ml-4"><h2 class="font-semibold">Auditor Feedback</h2><p class="mt-2 text-sm">${data.stats["complete_feedback"]}/${data.stats["feedback"]} complete</p></div></div></div>
          <div class="col-span-2 cursor-pointer hover:bg-base-200 hover:shadow-sm" @click="changeTab('subcontrols')"><div class="flex items-start rounded-xl py-4 px-3 border border-base-300"><div class="flex h-8 w-8 my-auto items-center justify-center rounded-full bg-base-200 border border-base-200"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg></div><div class="ml-4"><h2 class="font-semibold">InfoSec Control Status</h2><p class="mt-2 text-sm">${data.stats["infosec_status"]} waiting on InfoSec</p></div></div></div>
          <div class="col-span-2 cursor-pointer hover:bg-base-200 hover:shadow-sm" @click="changeTab('subcontrols')"><div class="flex items-start rounded-xl py-4 px-3 border border-base-300"><div class="flex h-8 w-8 my-auto items-center justify-center rounded-full bg-base-200 border border-base-200"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-gray-400 w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg></div><div class="ml-4"><h2 class="font-semibold">Auditor Control Status</h2><p class="mt-2 text-sm">${data.stats["auditor_status"]} waiting on Auditor</p></div></div></div>
        </div>
      `)
      $("#summary-div").append(`<div class="col-span-6"><div class="overflow-hidden  shadow sm:rounded-lg border border-base-200"><div class="px-4 py-6 sm:px-6 flex justify-between"><div><h3 class="text-lg font-medium leading-6 ">${data.id} - Control Details</h3><p class="mt-1 max-w-2xl text-sm ">Overview of your control details and status</p></div><div><button class="btn btn-ghost border border-base-300 btn-sm guidance-btn">View Guidance</button></div></div><div class="border-t border-base-200"><div class="grid grid-cols-9 px-6 py-5 gap-y-4">
          <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Status</strong><span class=" text-sm capitalize">${data.status}</span></div></div>
          <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Reference Code</strong><span class=" text-sm uppercase">${data.ref_code}</span></div></div>
          <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Complete</strong><span class=" text-sm capitalize">${data.is_complete}</span></div></div>
          <div class="col-span-9"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Name</strong><span class=" text-sm rounded-md border border-base-200 p-4 mt-2">${data.name}</span></div></div>
          <div class="col-span-9"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Description</strong><span class=" text-sm rounded-md border border-base-200 p-4 mt-2">${data.description}</span></div></div>
          <div class="col-span-9"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Guidance</strong><span class=" text-sm rounded-md border border-base-200 p-4 mt-2">${data.guidance}</span></div></div>
          <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Category</strong><span class=" text-sm capitalize">${data.category}</span></div></div>
          <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Subcategory</strong><span class=" text-sm capitalize">${data.subcategory}</span></div></div>
          <div class="col-span-3"><div class="flex flex-col"><strong class="font-semibold text-primary text-sm">Creation</strong><span class=" text-sm">${data.date_added}</span></div></div>
        </div></div></div></div>`);
      $("#project-details").append(`<div class="px-4 py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6"><dt class="text-sm font-medium ">Name</dt><dd class="mt-1 text-sm  sm:col-span-2 sm:mt-0">${data.name}</dd></div>`)
      return(data)
    },
    error: function(errMsg) {
        toast(errMsg["responseJSON"]["message"],"error")
        return(errMsg);
    }
  })
}

  $(document).on('click', '.guidance-btn', function() {
    document.getElementById('guidance-modal').checked = true;
  });
  $(document).on('click', '.btn-na', function() {
    var applicable = $(".btn-na").data("applicable");
    if (applicable === "yes") {
      data = {"applicable":false}
      msg = "Not Applicable"
      setApplicableBtn(false)
    } else {
      data = {"applicable":true}
      msg = "Applicable"
      setApplicableBtn(true)
    }
    $.ajax({
      type: "PUT",
      url: "/api/v1/project-controls/{{project_control.id}}/applicability",
      data: JSON.stringify(data),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function(data){
          toast(`Control has been set as ${msg}`)
          $(".svg-reload").addClass("animate-spin")
          return(data)
      },
      error: function(errMsg) {
          toast(errMsg["responseJSON"]["message"],"error")
          return(errMsg);
      }
    })  
  });
  function saveSubControl(subId, notify=true) {
    var applicable = $(`.input-${subId}-applicable`).is(':checked');
    var implemented = parseInt($(`.input-${subId}-implemented`).val());
    var evidence = $(`.input-${subId}-evidence`).val()
    var notes = $(`.input-${subId}-notes`).val()
    var feedback = $(`.input-${subId}-feedback`).val()
    var data = {
      "applicable":applicable,
      "implemented":implemented,
      "evidence":evidence,
      "notes":notes,
      "feedback":feedback,
    };
    $.ajax({
      type: "PUT",
      url: `/api/v1/project-controls/{{project_control.id}}/subcontrols/${subId}`,
      data: JSON.stringify(data),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function(data){
          if (notify) {
            toast('Updated the subcontrol. <button class="float-right btn btn-xs hover:bg-primary hover:border-primary ml-3" @click="reload">Reload</button>')
          }
          $(".svg-reload").addClass("animate-spin")
          return(data)
      },
      error: function(errMsg) {
          toast(errMsg["responseJSON"]["message"],"error")
          return(errMsg);
      }
    })
  }
  $(document).on('click', '.save-fa', function() {
    var subId = $(this).data('id')
    saveSubControl(subId)
  });
  
  $(document).on('click', '.save-all', function() {
    $('.save-fa').each(function(i, obj) {
      var id = $(this).data("id");
      saveSubControl(id, notify=false)
    });
    toast('Saved the subcontrols. <button class="float-right btn btn-xs hover:bg-primary hover:border-primary ml-3" @click="reload">Reload</button>')
  });
  $(document).on('click', '.toggle-fa', function() {
    if ($(".collapse").hasClass("collapse-open")) {
      $(".collapse").removeClass("collapse-open")
    } else {
      $(".collapse").addClass("collapse-open")
    }
  });
$(document).on('click', '.reload-button', function() {
  reload()
});
function reload() {
  $(".svg-reload").removeClass("animate-spin")
  loadSummary();
  loadCharts();
  loadSubControls();
}

// on load of page
function loadPageElements() {
  getComments()
  saveEvidenceToLs();
  loadSummary();
  loadCharts();
  loadSubControls();
};
loadPageElements()
</script>
{%endblock%}
